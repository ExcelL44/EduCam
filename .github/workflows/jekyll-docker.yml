name: ğŸ›¡ï¸ Robustesse EduCam - Test Cameroun

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # Matrix : teste plusieurs configs de devices camerounais
    strategy:
      matrix:
        api-level: [28, 29] # Android 9 et 10 (95% du marchÃ© Cameroun)
        target: [google_apis]
        arch: [x86_64]
        ram: [1024MB, 1536MB] # Simule Tecno Spark 1GB et Infinix 1.5GB
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: ğŸ” VÃ©rification Assets Offline
        run: |
          echo "âœ… VÃ©rification KaTeX et SVG..."
          if [ ! -f "app/src/main/assets/katex/katex.min.js" ]; then
            echo "âŒ KaTeX manquant !"
            exit 1
          fi
          if [ $(find app/src/main/assets -name "*.svg" | wc -l) -lt 100 ]; then
            echo "âš ï¸ Moins de 100 SVG trouvÃ©s"
          fi
          echo "ğŸ“Š Taille totale assets : $(du -sh app/src/main/assets | cut -f1)"

      - name: ğŸ§ª Tests Unitaires (+ Couverture)
        run: |
          ./gradlew testDebugUnitTest jacocoTestReport --parallel
          
      - name: ğŸ“Š Upload rapport couverture
        uses: actions/upload-artifact@v3
        with:
          name: rapport-couverture-${{ matrix.ram }}
          path: app/build/reports/jacoco/test/html/
          
      - name: âŒ Fail si couverture < 80%
        run: |
          COVERAGE=$(grep -oP 'Total.*?([0-9]+)%' app/build/reports/jacoco/test/html/index.html | grep -oP '[0-9]+' | head -1)
          if [ "$COVERAGE" -lt 80 ]; then
            echo "âŒ Couverture insuffisante : ${COVERAGE}% (min 80%)"
            exit 1
          fi
          echo "âœ… Couverture acceptable : ${COVERAGE}%"

      - name: ğŸ”§ Build Release (Check APK size)
        run: |
          ./gradlew assembleRelease
          APK_SIZE=$(stat -c%s "app/build/outputs/apk/release/app-release.apk")
          APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
          echo "ğŸ“¦ APK size : ${APK_SIZE_MB}MB"
          if [ $APK_SIZE_MB -gt 30 ]; then
            echo "âš ï¸ APK > 30MB, vÃ©rifiez les assets !"
            # Ne fail pas, mais alerte
          fi

      - name: ğŸ“± Start Emulator (Config Cameroun)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: ${{ matrix.arch }}
          profile: Nexus 5X # Taille Ã©cran similaire Tecno
          ram-size: ${{ matrix.ram }}
          heap-size: 256M
          sdcard-size: 512M
          emulator-options: -no-snapshot-save -no-audio -gpu swiftshader_indirect -no-boot-anim
          script: |
            echo "ğŸŒ Simulating 2G network..."
            adb shell svc data prefer 2g
            adb shell settings put global mobile_data 1
            adb shell settings put global airplane_mode_on 0
            
            ./gradlew connectedDebugAndroidTest

      - name: ğŸ“¤ Upload logs tests instrumentÃ©s
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.api-level }}-${{ matrix.ram }}
          path: |
            app/build/reports/androidTests/connected/
            app/build/outputs/androidTest-results/

      - name: ğŸš¨ VÃ©rification OOM dans logs
        if: always()
        run: |
          if grep -r "OutOfMemoryError" app/build/outputs/androidTest-results/; then
            echo "âŒ CRASH OOM dÃ©tectÃ© !"
            exit 1
          fi
          if grep -r "java.lang.RuntimeException.*WebView" app/build/outputs/androidTest-results/; then
            echo "âŒ ERREUR WebView dÃ©tectÃ©e !"
            exit 1
          fi

      - name: ğŸ”¥ Tests Performance (Custom)
        run: |
          # Lance un test de charge : 50 questions consÃ©cutives
          ./gradlew :app:connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.edacam.performance.LoadTest#test50QuestionsConsecutives
          
          # VÃ©rifie temps moyen
          TIME=$(grep -oP 'avg_time=\K[0-9]+' app/build/outputs/androidTest-results/*.xml)
          if [ "$TIME" -gt 2000 ]; then # 2s max par question
            echo "âš ï¸ Performance dÃ©gradÃ©e : ${TIME}ms/question"
          fi

      - name: ğŸ§¹ Nettoyage cache
        if: always()
        run: |
          ./gradlew clean
          rm -rf ~/.gradle/caches

  # Job parallÃ¨le : SÃ©curitÃ© et QualitÃ© de Code
  static-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ” Detekt (QualitÃ© Kotlin)
        run: |
          ./gradlew detekt
          if [ -f "build/reports/detekt/detekt.html" ]; then
            echo "âœ… Rapport Detekt gÃ©nÃ©rÃ©"
          fi
      
      - name: ğŸ“ Lint Android
        run: |
          ./gradlew lintDebug
          # Fail sur erreurs critiques
          if grep -q "severity=\\"Error\\"" app/build/reports/lint-results-debug.xml; then
            echo "âŒ Lint errors found !"
            exit 1
          fi
      
      - name: ğŸ“¦ Upload rapports static analysis
        uses: actions/upload-artifact@v3
        with:
          name: static-analysis-reports
          path: |
            app/build/reports/detekt/
            app/build/reports/lint-results-debug.html

  # Job final : SynthÃ¨se de robustesse
  robustesse-report:
    needs: [build-and-test, static-analysis]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ TÃ©lÃ©charger tous les artefacts
        uses: actions/download-artifact@v3
        
      - name: ğŸ“Š GÃ©nÃ©rer score de robustesse
        run: |
          echo "=== SCORE DE ROBUSTESSE EDUCAM ===" > robustesse-score.txt
          echo "" >> robustesse-score.txt
          
          # Score mÃ©moire
          if grep -q "ram-size=1024MB" <<< "${{ matrix.ram }}"; then
            echo "âœ… TestÃ© sur 1GB RAM (Tecno Spark)" >> robustesse-score.txt
            MEM_SCORE=30
          else
            MEM_SCORE=20
          fi
          
          # Score couverture
          COVERAGE=$(grep -oP '[0-9]+' rapport-couverture-*/index.html | head -1)
          COV_SCORE=$((COVERAGE / 10))
          
          # Score build
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            BUILD_SCORE=20
          else
            BUILD_SCORE=0
          fi
          
          TOTAL=$((MEM_SCORE + COV_SCORE + BUILD_SCORE))
          
          echo "MÃ©moire (30 max) : $MEM_SCORE/30" >> robustesse-score.txt
          echo "Couverture (10 max) : $COV_SCORE/10" >> robustesse-score.txt
          echo "Build (20 max) : $BUILD_SCORE/20" >> robustesse-score.txt
          echo "TOTAL : $TOTAL/100" >> robustesse-score.txt
          
          if [ $TOTAL -lt 50 ]; then
            echo "âŒ SCORE < 50% - Robustesse insuffisante !"
            exit 1
          fi
          
          echo "âœ… Score de robustesse : $TOTAL% (min: 50%)"
          
      - name: ğŸ“¤ Upload score final
        uses: actions/upload-artifact@v3
        with:
          name: robustesse-final-report
          path: robustesse-score.txt

      - name: ğŸ”” Notification Discord/Slack (si Ã©chec)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "âŒ EduCam a Ã©chouÃ© les tests de robustesse !"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
