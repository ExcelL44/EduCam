name: ğŸ”¥ Stress Tests

on:
  schedule:
    # ExÃ©cuter tous les jours Ã  2h du matin
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'DurÃ©e des tests (minutes)'
        required: false
        default: '30'

jobs:
  # âœ… Stress Test 1 : Navigation Rapide
  stress-navigation:
    name: ğŸ§­ Navigation Stress Test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew
        
      - name: ğŸ¤– Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
      - name: ğŸ”¥ Run Navigation Stress Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_4
          disable-animations: true
          script: |
            echo "ğŸ”¥ Lancement du stress test navigation..."
            ./gradlew connectedDebugAndroidTest \
              -Pandroid.testInstrumentationRunnerArguments.class=com.excell44.educam.NavigationStressTest \
              --stacktrace
              
      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: navigation-stress-results
          path: app/build/reports/androidTests/
          retention-days: 30
          
      - name: ğŸ“ˆ Analyze Results
        if: always()
        run: |
          echo "ğŸ“Š Analyse des rÃ©sultats..."
          
          # Chercher les crashs dans les logs
          CRASHES=$(grep -i "crash\|fatal\|exception" app/build/reports/androidTests/ -r || true)
          
          if [ -n "$CRASHES" ]; then
            echo "âŒ Ã‰CHEC : Crashs dÃ©tectÃ©s pendant le stress test !"
            echo "$CRASHES"
            exit 1
          else
            echo "âœ… SUCCÃˆS : Aucun crash dÃ©tectÃ© !"
          fi

  # âœ… Stress Test 2 : Spam Bouton
  stress-button-spam:
    name: ğŸ–±ï¸ Button Spam Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew
        
      - name: ğŸ¤– Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
      - name: ğŸ”¥ Run Button Spam Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_4
          disable-animations: true
          script: |
            echo "ğŸ”¥ Test de spam sur les boutons..."
            ./gradlew connectedDebugAndroidTest \
              -Pandroid.testInstrumentationRunnerArguments.class=com.excell44.educam.ButtonSpamTest \
              --stacktrace
              
      - name: ğŸ“Š Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: button-spam-results
          path: app/build/reports/androidTests/
          retention-days: 30

  # âœ… Stress Test 3 : Rotation Stress
  stress-rotation:
    name: ğŸ”„ Rotation Stress Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew
        
      - name: ğŸ¤– Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
      - name: ğŸ”¥ Run Rotation Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_4
          script: |
            echo "ğŸ”¥ Test de rotations rapides..."
            ./gradlew connectedDebugAndroidTest \
              -Pandroid.testInstrumentationRunnerArguments.class=com.excell44.educam.RotationStressTest \
              --stacktrace
              
      - name: ğŸ“Š Check for Memory Leaks
        if: always()
        run: |
          echo "ğŸ” VÃ©rification des fuites mÃ©moire..."
          
          # Analyser les logs LeakCanary
          LEAKS=$(grep -i "leak\|retain" app/build/outputs/androidTest-results/ -r || true)
          
          if [ -n "$LEAKS" ]; then
            echo "âš ï¸ AVERTISSEMENT : Fuites potentielles dÃ©tectÃ©es"
            echo "$LEAKS"
          else
            echo "âœ… Aucune fuite mÃ©moire dÃ©tectÃ©e"
          fi
          
      - name: ğŸ“Š Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rotation-stress-results
          path: app/build/reports/androidTests/
          retention-days: 30

  # âœ… Stress Test 4 : Memory Pressure
  stress-memory:
    name: ğŸ’¾ Memory Pressure Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew
        
      - name: ğŸ¤– Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
      - name: ğŸ”¥ Run Memory Pressure Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_4
          ram-size: 2048M  # Limite la RAM pour simuler low-end device
          script: |
            echo "ğŸ”¥ Test avec mÃ©moire limitÃ©e..."
            ./gradlew connectedDebugAndroidTest \
              -Pandroid.testInstrumentationRunnerArguments.class=com.excell44.educam.MemoryStressTest \
              --stacktrace
              
      - name: ğŸ“Š Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: memory-stress-results
          path: app/build/reports/androidTests/
          retention-days: 30

  # âœ… RAPPORT FINAL
  stress-report:
    name: ğŸ“Š Stress Test Report
    runs-on: ubuntu-latest
    needs: [stress-navigation, stress-button-spam, stress-rotation, stress-memory]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download All Results
        uses: actions/download-artifact@v4
        with:
          path: test-results/
          
      - name: ğŸ“Š Generate Report
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RAPPORT DE STRESS TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Date : $(date)"
          echo ""
          
          # VÃ©rifier les rÃ©sultats de chaque test
          for test in navigation-stress button-spam rotation-stress memory-stress; do
            if [ -d "test-results/${test}-results" ]; then
              FAILURES=$(grep -i "failure\|error" test-results/${test}-results -r || true)
              if [ -z "$FAILURES" ]; then
                echo "âœ… $test : SUCCÃˆS"
              else
                echo "âŒ $test : Ã‰CHEC"
              fi
            else
              echo "âš ï¸ $test : PAS EXÃ‰CUTÃ‰"
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: ğŸ“§ Send Report (optionnel)
        if: failure()
        run: |
          echo "âš ï¸ Certains tests de stress ont Ã©chouÃ©"
          echo "ğŸ“§ Rapport envoyÃ© Ã  l'Ã©quipe"
          # Ici, ajouter intÃ©gration Slack/Email si nÃ©cessaire
