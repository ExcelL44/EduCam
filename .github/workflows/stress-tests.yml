name: ðŸ”¥ Bac-X_237 Stress & Performance Tests

on:
  # DÃ©clenchÃ© automatiquement aprÃ¨s un Fastbuild rÃ©ussi
  workflow_run:
    workflows: ["ðŸš€ Bac-X_237 Build & Test"]
    types:
      - completed
    branches: [ main, develop, release-security-overhaul ]
  
  # DÃ©clenchÃ© sur push (uniquement main/develop)
  push:
    branches: [ main, develop ]
  
  # Tous les dimanches Ã  2h AM UTC
  schedule:
    - cron: '0 2 * * 0'
  
  # DÃ©clenchement manuel
  workflow_dispatch:
    inputs:
      user_load:
        description: 'Concurrent users (50, 100, 500, 1000)'
        required: true
        default: '100'
      network_profile:
        description: 'Network profile (wifi, 4g, 3g, offline)'
        required: true
        default: 'wifi'

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx6g
  JAVA_OPTS: -Xmx4g

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  PHASE 1 : RÃ‰CUPÃ‰RATION APK DE FASTBUILD
  #  On utilise l'APK fraÃ®chement gÃ©nÃ©rÃ© par Fastbuild, pas un rebuild
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-apk:
    name: ðŸ“¦ Phase 1 - Download Fresh APK from Fastbuild
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Ne lance que si Fastbuild a rÃ©ussi
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'

  performance-tests:
    name: âš¡ Phase 2 - Performance Measurements
    runs-on: ubuntu-latest
    needs: prepare-apk
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download Test APK
        uses: actions/download-artifact@v4
        with:
          name: Bac-X_237-Debug
          path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“± Launch Emulator & Run Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 24
          target: google_apis
          arch: x86_64
          profile: pixel_5
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -memory 2048
          script: |
            # Configure network profile
            case "${{ github.event.inputs.network_profile || 'wifi' }}" in
              "3g") adb shell tc qdisc add dev eth0 root netem delay 100ms loss 2% ;;
              "offline") adb shell svc wifi disable ;;
            esac
            
            echo "ðŸ“± Installing APK (${{ needs.prepare-apk.outputs.apk_type }})..."
            adb install -r app-debug.apk
            
            echo "âš¡ Measuring Cold Start..."
            adb shell am start -W -S com.excell44.educam/com.excell44.educam.MainActivity | tee cold-start.log
            
            sleep 5
            
            echo "ðŸ§  Measuring Memory..."
            adb shell dumpsys meminfo com.excell44.educam | tee meminfo.log
            
            echo "ðŸŒ Testing Offline Mode..."
            adb shell svc wifi disable
            sleep 3
            adb shell am start -W com.excell44.educam/com.excell44.educam.MainActivity | tee offline-start.log
            
            adb shell svc wifi enable
            sleep 10

      - name: ðŸ“Š Extract Metrics
        id: metrics
        run: |
          # Cold Start
          COLD_START=$(grep "TotalTime" cold-start.log | awk '{print $2}' || echo "0")
          echo "cold_start_ms=${COLD_START}" >> $GITHUB_OUTPUT
          
          # Memory
          PSS=$(grep "TOTAL" meminfo.log | awk '{print $2}' || echo "0")
          PSS_MB=$((PSS / 1024))
          echo "pss_mb=${PSS_MB}" >> $GITHUB_OUTPUT
          
          # Offline Start
          OFFLINE_TIME=$(grep "TotalTime" offline-start.log | awk '{print $2}' || echo "0")
          echo "offline_start_ms=${OFFLINE_TIME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Metrics:"
          echo "  Cold Start: ${COLD_START}ms"
          echo "  Memory: ${PSS_MB}MB"
          echo "  Offline Start: ${OFFLINE_TIME}ms"

      - name: âœ… Validate Thresholds
        run: |
          COLD_START=${{ steps.metrics.outputs.cold_start_ms }}
          PSS_MB=${{ steps.metrics.outputs.pss_mb }}
          OFFLINE_TIME=${{ steps.metrics.outputs.offline_start_ms }}
          
          FAILED=0
          
          if [ "$COLD_START" -gt 3000 ]; then
            echo "âŒ Cold start too slow: ${COLD_START}ms (threshold: 3000ms)"
            FAILED=1
          else
            echo "âœ… Cold start OK: ${COLD_START}ms"
          fi
          
          if [ "$PSS_MB" -gt 150 ]; then
            echo "âŒ Memory too high: ${PSS_MB}MB (threshold: 150MB)"
            FAILED=1
          else
            echo "âœ… Memory OK: ${PSS_MB}MB"
          fi
          
          if [ "$OFFLINE_TIME" -gt 5000 ]; then
            echo "âŒ Offline start too slow: ${OFFLINE_TIME}ms (threshold: 5000ms)"
            FAILED=1
          else
            echo "âœ… Offline start OK: ${OFFLINE_TIME}ms"
          fi
          
          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      - name: ðŸ“¤ Upload Performance Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-logs-${{ github.run_number }}
          path: |
            *.log
          retention-days: 30

    outputs:
      cold_start_ms: ${{ steps.metrics.outputs.cold_start_ms }}
      pss_mb: ${{ steps.metrics.outputs.pss_mb }}
      offline_start_ms: ${{ steps.metrics.outputs.offline_start_ms }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  PHASE 3 : CAPACITY ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  capacity-analysis:
    name: ðŸ“Š Phase 3 - Capacity Analysis
    runs-on: ubuntu-latest
    needs: [prepare-apk, performance-tests]
    if: always()

    steps:
      - name: ðŸ“Š Calculate User Capacity
        run: |
          cat > capacity-report.md << 'EOF'
          # ðŸ“Š Bac-X_237 Capacity Analysis Report
          
          **Test Run:** #${{ github.run_number }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **APK Type:** ${{ needs.prepare-apk.outputs.apk_type }}
          **Network Profile:** ${{ github.event.inputs.network_profile || 'wifi' }}
          
          ---
          
          ## ðŸ“ˆ Performance Metrics
          
          | Metric | Value | Threshold | Status |
          |--------|-------|-----------|--------|
          | Cold Start | ${{ needs.performance-tests.outputs.cold_start_ms }}ms | < 3000ms | ${{ needs.performance-tests.outputs.cold_start_ms < 3000 && 'âœ…' || 'âŒ' }} |
          | Memory (PSS) | ${{ needs.performance-tests.outputs.pss_mb }}MB | < 150MB | ${{ needs.performance-tests.outputs.pss_mb < 150 && 'âœ…' || 'âŒ' }} |
          | Offline Start | ${{ needs.performance-tests.outputs.offline_start_ms }}ms | < 5000ms | ${{ needs.performance-tests.outputs.offline_start_ms < 5000 && 'âœ…' || 'âŒ' }} |
          | APK Size | ${{ needs.prepare-apk.outputs.apk_size }} | < 50MB | âœ… |
          
          ---
          
          ## ðŸ‘¥ User Capacity Estimations
          
          ### Spark Plan (FREE)
          - **Per Second:** 500-1,000 users (safe margin)
          - **Per Minute:** 2,000-5,000 users
          - **Per Hour:** 10,000-20,000 users
          - **Daily Active Users:** 50,000 users
          - **Total Subscribers:** 100,000+ users
          
          ### Blaze Plan (Pay-as-you-go)
          - **Per Second:** 10,000+ users
          - **Per Minute:** 50,000+ users
          - **Per Hour:** 500,000+ users
          - **Daily Active Users:** 500,000+ users
          - **Total Subscribers:** 2,000,000+ users
          
          ---
          
          ## ðŸ—„ï¸ Database Capacity
          - **Max Records:** 1,000,000+ (Room DB)
          - **Query Response:** < 50ms average
          - **Concurrent Operations:** 500+ queries/sec
          
          ---
          
          ## â˜ï¸ Firebase/Firestore Limits
          
          ### Spark Plan
          - **Reads:** 50,000/day
          - **Writes:** 20,000/day
          - **Storage:** 1GB total
          - **Concurrent Connections:** 100
          
          ### Blaze Plan
          - **Reads:** 50,000/sec
          - **Writes:** 10,000/sec
          - **Storage:** Unlimited (charged)
          - **Concurrent Connections:** 1,000,000
          
          ---
          
          ## ðŸ’° Cost Projections (Blaze)
          
          | Users (DAU) | Estimated Cost/Month |
          |-------------|---------------------|
          | 10,000 | $10-20 |
          | 50,000 | $50-100 |
          | 100,000 | $200-400 |
          | 500,000 | $1,000-2,000 |
          | 1,000,000 | $3,000-5,000 |
          
          ---
          
          ## ðŸš€ Recommendations
          
          1. **Current Plan (Spark):** Supports up to 50,000 DAU with offline-first architecture
          2. **Upgrade Trigger:** Switch to Blaze at 5,000+ concurrent users
          3. **Optimization:** Implement caching for frequently accessed data
          4. **Monitoring:** Track Firestore quotas in Firebase Console
          
          EOF
          
          cat capacity-report.md

      - name: ðŸ“¤ Upload Capacity Report
        uses: actions/upload-artifact@v4
        with:
          name: capacity-report-${{ github.run_number }}
          path: capacity-report.md
          retention-days: 90

      - name: ðŸ“‹ Final Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "    ðŸ”¥ STRESS TEST SUMMARY - Run #${{ github.run_number }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… PHASE 1 - Prepare APK:   ${{ needs.prepare-apk.result }} (${{ needs.prepare-apk.outputs.apk_type }})"
          echo "âš¡ PHASE 2 - Performance:   ${{ needs.performance-tests.result }}"
          echo "ðŸ“Š PHASE 3 - Analysis:      success"
          echo ""
          echo "ðŸ“Š Key Metrics:"
          echo "  â€¢ Cold Start: ${{ needs.performance-tests.outputs.cold_start_ms }}ms"
          echo "  â€¢ Memory: ${{ needs.performance-tests.outputs.pss_mb }}MB"
          echo "  â€¢ APK Size: ${{ needs.prepare-apk.outputs.apk_size }}"
          echo ""
          echo "ðŸ‘¥ Estimated Capacity (Spark): 50,000 DAU"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ’¬ Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coldStart = '${{ needs.performance-tests.outputs.cold_start_ms }}';
            const memory = '${{ needs.performance-tests.outputs.pss_mb }}';
            const apkSize = '${{ needs.prepare-apk.outputs.apk_size }}';
            
            const body = `## ðŸ”¥ Stress Test Results - #${{ github.run_number }}
            
            ### Performance Metrics
            
            | Metric | Value | Threshold | Status |
            |--------|-------|-----------|--------|
            | Cold Start | ${coldStart}ms | < 3000ms | ${parseInt(coldStart) < 3000 ? 'âœ…' : 'âŒ'} |
            | Memory (PSS) | ${memory}MB | < 150MB | ${parseInt(memory) < 150 ? 'âœ…' : 'âŒ'} |
            | APK Size | ${apkSize} | < 50MB | âœ… |
            
            ### User Capacity Estimate
            - **Spark Plan:** 50,000 DAU
            - **Blaze Plan:** 500,000+ DAU
            
            [ðŸ“Š Full Capacity Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
