name: ğŸš€ Android Fast Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Dorg.gradle.parallel=true -Xmx4g
  JAVA_OPTS: -Xmx4g

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  ğŸ« JOB 1 : TESTS CRITIQUES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  critical-tests:
    name: ğŸ§ª Critical Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ”§ Fix Gradlew Permissions
        run: |
          chmod +x gradlew
          sed -i 's/\r$//' gradlew

      - name: ğŸ§¹ Clean Build
        run: ./gradlew clean --no-daemon

      - name: ğŸ”¢ Update Version Code
        run: |
          VERSION_NAME=$(grep "versionName" app/build.gradle.kts | awk '{print $2}' | tr -d '"')
          TIMESTAMP=$(date +%s)
          VERSION_CODE=$((GITHUB_RUN_NUMBER + TIMESTAMP))
          sed -i "s/versionCode = [0-9]*/versionCode = ${VERSION_CODE}/" app/build.gradle.kts
          sed -i "s/versionName = \"[^\"]*\"/versionName = \"${VERSION_NAME}-SNAPSHOT-${GITHUB_RUN_NUMBER}\"/" app/build.gradle.kts
          echo "âœ… Version updated to: ${VERSION_NAME}-SNAPSHOT-${GITHUB_RUN_NUMBER} (code: ${VERSION_CODE})"

      # âœ… MODIFICATION 1 : Capture la sortie dans un fichier log
      - name: ğŸ”¨ Compile & Test
        run: ./gradlew assembleDebug testDebugUnitTest --no-daemon --stacktrace 2>&1 | tee build-output.log
        # continue-on-error: true  # DÃ©commentez si vous voulez capturer mÃªme en succÃ¨s

      - name: ğŸ” Run Lint
        run: ./gradlew lintDebug --no-daemon --stacktrace
        continue-on-error: true

      # âœ… MODIFICATION 2 : Extrait la premiÃ¨re erreur si les tests Ã©chouent
      - name: ğŸ“„ Extract First Error
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" > first-error.txt
          echo "âŒ PREMIÃˆRE ERREUR DÃ‰TECTÃ‰E - Build #${GITHUB_RUN_NUMBER}" >> first-error.txt
          echo "Commit: ${GITHUB_SHA}" >> first-error.txt
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> first-error.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> first-error.txt
          echo "" >> first-error.txt
          
          # MÃ©thode 1 : Chercher dans les rapports de test (plus prÃ©cis)
          if [ -d "app/build/test-results/testDebugUnitTest/" ]; then
            echo "ğŸ“Š ERREUR DANS LES TESTS UNITAIRES :" >> first-error.txt
            find app/build/test-results/testDebugUnitTest -name "*.xml" -exec grep -l "<failure\|<error" {} \; | while read file; do
              echo "â†’ Fichier: $file" >> first-error.txt
              grep -A 30 '<failure\|<error' "$file" | sed 's/<[^>]*>/ /g' >> first-error.txt 2>&1
              break
            done
          fi
          
          # MÃ©thode 2 : Si pas de rapport, chercher dans la sortie gradle
          if grep -q "BUILD FAILED" first-error.txt || [ ! -s first-error.txt ]; then
            echo "ğŸ”§ ERREUR DE COMPILATION/BUILD :" >> first-error.txt
            grep -B 5 -A 15 "BUILD FAILED\|Execution failed\|error:\|Exception:" build-output.log | head -80 >> first-error.txt 2>&1
          fi
          
          echo "" >> first-error.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> first-error.txt
          
          # Affiche dans les logs GitHub pour visibilitÃ© immÃ©diate
          echo "âŒ ERREUR CAPTURÃ‰E :"
          cat first-error.txt

      - name: ğŸ“Š Upload Test Reports & Error
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-reports-${{ github.sha }}-run${{ github.run_number }}
          path: |
            app/build/reports/tests/
            app/build/reports/lint-results*.html
            first-error.txt
            build-output.log
          retention-days: 7  # AugmentÃ© pour debug

      # âœ… MODIFICATION 3 : Affiche l'erreur mÃªme en cas de succÃ¨s (optionnel, pour debug)
      - name: ğŸ“ Display Build Summary
        if: always()
        run: |
          if [ -f first-error.txt ]; then
            echo "ğŸ“„ Fichier d'erreur gÃ©nÃ©rÃ© : first-error.txt"
            wc -l first-error.txt
          else
            echo "âœ… Aucune erreur dÃ©tectÃ©e"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  ğŸ« JOB 2 : BUILD DEBUG APK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-debug:
    name: ğŸ“¦ Build Debug APK
    runs-on: ubuntu-latest
    needs: critical-tests
    timeout-minutes: 30
    if: always()  # Build mÃªme si tests Ã©chouent (mais peut Ãªtre modifiÃ©)
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ”§ Fix Gradlew Permissions
        run: |
          chmod +x gradlew
          sed -i 's/\r$//' gradlew

      - name: ğŸ§¹ Clean Build
        run: ./gradlew clean --no-daemon

      - name: ğŸ”¢ Update Version Code
        run: |
          VERSION_NAME=$(grep "versionName" app/build.gradle.kts | awk '{print $2}' | tr -d '"')
          TIMESTAMP=$(date +%s)
          VERSION_CODE=$((GITHUB_RUN_NUMBER + TIMESTAMP))
          sed -i "s/versionCode = [0-9]*/versionCode = ${VERSION_CODE}/" app/build.gradle.kts
          sed -i "s/versionName = \"[^\"]*\"/versionName = \"${VERSION_NAME}-SNAPSHOT-${GITHUB_RUN_NUMBER}\"/" app/build.gradle.kts
          echo "âœ… Version updated to: ${VERSION_NAME}-SNAPSHOT-${GITHUB_RUN_NUMBER} (code: ${VERSION_CODE})"

      - name: ğŸ“¦ Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace --rerun-tasks

      - name: ğŸ·ï¸ Rename APK
        run: |
          cd app/build/outputs/apk/debug
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mv app-debug.apk app-debug-${{ github.run_number }}-${TIMESTAMP}.apk
          echo "âœ… APK renamed with timestamp"

      - name: ğŸš€ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ github.sha }}-${{ github.run_number }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  ğŸ« JOB 3 : FINAL REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  final-report:
    name: âœ… Final Report
    runs-on: ubuntu-latest
    needs: [critical-tests, build-debug]
    if: always()
    
    steps:
      - name: ğŸ‰ Build Status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RAPPORT FINAL DU BUILD"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Tests: ${{ needs.critical-tests.result }}"
          echo "Debug APK: ${{ needs.build-debug.result }}"
          
      # âœ… MODIFICATION 4 : TÃ©lÃ©charge et affiche l'erreur si les tests ont Ã©chouÃ©
      - name: ğŸ“¥ Download Error Report
        if: needs.critical-tests.result == 'failure'
        uses: actions/download-artifact@v4
        with:
          name: test-reports-${{ github.sha }}-run${{ github.run_number }}
          
      - name: ğŸš¨ Display First Error Summary
        if: needs.critical-tests.result == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨ RÃ‰SUMÃ‰ DE LA PREMIÃˆRE ERREUR"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -f first-error.txt ]; then
            cat first-error.txt
          else
            echo "âŒ Erreur dÃ©tectÃ©e mais fichier first-error.txt introuvable"
            echo "Consultez les artefacts tÃ©lÃ©chargÃ©s pour les logs complets"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
