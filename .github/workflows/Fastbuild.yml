name: ðŸš€ Bac-X_237 Build & Test

on:
  push:
    branches: [ main, develop, release-security-overhaul ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Xmx4g
  JAVA_OPTS: -Xmx4g

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  PHASE 1 : COMPILING & UNIT TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  compile-and-test:
    name: âš™ï¸ Phase 1 - Compiling & Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ” Restore google-services.json (Base64)
        env:
          GOOGLE_SERVICE_SECRETS: ${{ secrets.GOOGLE_SERVICE_SECRETS }}
        run: |
          if [ -z "$GOOGLE_SERVICE_SECRETS" ]; then
            echo "âš ï¸ WARNING: GOOGLE_SERVICE_SECRETS not set, using dummy"
            cat > app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "123456789",
              "project_id": "dummy-project-id",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789:android:dummy",
                  "android_client_info": {
                    "package_name": "com.excell44.educam"
                  }
                },
                "oauth_client": [],
                "api_key": [{"current_key": "AIzaDummyKeyForTestingOnly"}],
                "services": {"appinvite_service": {"other_platform_oauth_client": []}}
              }
            ],
            "configuration_version": "1"
          }
          EOF
          else
            echo "âœ… Decoding GOOGLE_SERVICE_SECRETS (base64)"
            echo "$GOOGLE_SERVICE_SECRETS" | base64 -d > app/google-services.json
            
            FILE_SIZE=$(wc -c < app/google-services.json)
            if [ $FILE_SIZE -lt 100 ]; then
              echo "âŒ google-services.json invalid (size: $FILE_SIZE bytes)"
              exit 1
            fi
            echo "âœ… google-services.json restored ($FILE_SIZE bytes)"
          fi

      - name: ðŸ”§ Prepare Gradle
        run: |
          chmod +x gradlew
          sed -i 's/\r$//' gradlew

      - name: ðŸ”¢ Generate Version
        id: version
        run: |
          VERSION_NAME=$(grep "versionName" app/build.gradle.kts | awk '{print $3}' | tr -d '"')
          BUILD_NUMBER=${{ github.run_number }}
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          VERSION_CODE=$((1000 + BUILD_NUMBER))
          BUILD_TYPE=$([[ "${{ github.event_name }}" == "pull_request" ]] && echo "PR" || echo "PROD")
          FULL_VERSION="${VERSION_NAME}-${BUILD_TYPE}-${BUILD_NUMBER}-${COMMIT_SHORT}"
          
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Version: ${FULL_VERSION} (code: ${VERSION_CODE})"

      - name: ðŸ“ Update Build Config
        run: |
          sed -i "s/versionCode = [0-9]*/versionCode = ${{ steps.version.outputs.version_code }}/" app/build.gradle.kts
          sed -i "s/versionName = \"[^\"]*\"/versionName = \"${{ steps.version.outputs.full_version }}\"/" app/build.gradle.kts

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      #  COMPILATION & TESTS UNITAIRES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âš™ï¸ Compile & Run Unit Tests
        id: compile
        run: |
          set -o pipefail
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ Phase 1: Compiling & Unit Testing"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          START_TIME=$(date +%s)
          
          # Compilation + Tests unitaires (pas de build APK encore)
          ./gradlew compileDebugKotlin compileDebugJavaWithJavac testDebugUnitTest \
            --no-daemon \
            --stacktrace \
            --warning-mode all \
            2>&1 | tee compile-output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Compilation Metrics"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Duration: ${DURATION}s"
          echo "Exit Code: ${EXIT_CODE}"
          
          ERROR_COUNT=$(grep -c "error:" compile-output.log || echo "0")
          WARNING_COUNT=$(grep -c "warning:" compile-output.log || echo "0")
          
          echo "duration_sec=${DURATION}" >> $GITHUB_OUTPUT
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
          echo "errors=${ERROR_COUNT}" >> $GITHUB_OUTPUT
          echo "warnings=${WARNING_COUNT}" >> $GITHUB_OUTPUT
          
          echo "Errors: ${ERROR_COUNT}"
          echo "Warnings: ${WARNING_COUNT}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          exit ${EXIT_CODE}
        continue-on-error: true

      - name: ðŸ“Š Phase 1 Metrics
        if: always()
        run: |
          cat > phase1-metrics.json << EOF
          {
            "phase": "1-compile-test",
            "build_number": "${{ github.run_number }}",
            "duration_sec": "${{ steps.compile.outputs.duration_sec }}",
            "exit_code": "${{ steps.compile.outputs.exit_code }}",
            "errors": "${{ steps.compile.outputs.errors }}",
            "warnings": "${{ steps.compile.outputs.warnings }}",
            "timestamp": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          }
          EOF
          cat phase1-metrics.json

      - name: ðŸ” Run Lint Analysis
        if: steps.compile.outputs.exit_code == '0'
        run: |
          ./gradlew lintDebug --no-daemon 2>&1 | tee lint.log
        continue-on-error: true

      - name: ðŸ“Š Extract Compilation Errors
        if: steps.compile.outputs.exit_code != '0'
        run: |
          cat > compilation-errors.md << 'EOF'
          # ðŸš¨ Phase 1: Compilation Error Report
          
          **Build:** #${{ github.run_number }}
          **Phase:** Compiling & Unit Tests
          **Duration:** ${{ steps.compile.outputs.duration_sec }}s
          **Errors:** ${{ steps.compile.outputs.errors }}
          **Warnings:** ${{ steps.compile.outputs.warnings }}
          
          ---
          
          EOF
          
          if grep -q "error:" compile-output.log; then
            echo "## âŒ Compilation Errors" >> compilation-errors.md
            echo '```kotlin' >> compilation-errors.md
            grep -B 2 -A 5 "error:" compile-output.log | head -100 >> compilation-errors.md
            echo '```' >> compilation-errors.md
          fi
          
          cat compilation-errors.md

      - name: ðŸ“¤ Upload Phase 1 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase1-compilation-${{ github.run_number }}
          path: |
            compile-output.log
            phase1-metrics.json
            compilation-errors.md
            lint.log
            app/build/reports/tests/
          retention-days: 30

      - name: âŒ Fail if Compilation Failed
        if: steps.compile.outputs.exit_code != '0'
        run: |
          echo "âŒ Phase 1 FAILED: Compilation errors detected"
          echo "ðŸ“Š Metrics: ${{ steps.compile.outputs.duration_sec }}s, ${{ steps.compile.outputs.errors }} errors"
          exit 1

    outputs:
      version: ${{ steps.version.outputs.full_version }}
      version_code: ${{ steps.version.outputs.version_code }}
      compile_status: ${{ steps.compile.outputs.exit_code == '0' && 'success' || 'failure' }}
      compile_duration: ${{ steps.compile.outputs.duration_sec }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  PHASE 2 : BUILDING APK & RUNTIME SMOKE TEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-smoke-test:
    name: ðŸ”¨ Phase 2 - Building APK & Runtime Smoke Test
    runs-on: ubuntu-latest
    needs: compile-and-test
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ” Restore google-services.json (Base64)
        env:
          GOOGLE_SERVICE_SECRETS: ${{ secrets.GOOGLE_SERVICE_SECRETS }}
        run: |
          if [ -z "$GOOGLE_SERVICE_SECRETS" ]; then
            echo "âš ï¸ Using dummy google-services.json"
            cat > app/google-services.json << 'EOF'
          {
            "project_info": {"project_number": "123456789", "project_id": "dummy-project-id", "storage_bucket": "dummy-project.appspot.com"},
            "client": [{"client_info": {"mobilesdk_app_id": "1:123456789:android:dummy", "android_client_info": {"package_name": "com.excell44.educam"}}, "oauth_client": [], "api_key": [{"current_key": "AIzaDummyKeyForTestingOnly"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}],
            "configuration_version": "1"
          }
          EOF
          else
            echo "$GOOGLE_SERVICE_SECRETS" | base64 -d > app/google-services.json
          fi

      - name: ðŸ”§ Prepare Gradle
        run: |
          chmod +x gradlew
          sed -i 's/\r$//' gradlew

      - name: ðŸ“ Restore Version
        run: |
          sed -i "s/versionCode = [0-9]*/versionCode = ${{ needs.compile-and-test.outputs.version_code }}/" app/build.gradle.kts
          sed -i "s/versionName = \"[^\"]*\"/versionName = \"${{ needs.compile-and-test.outputs.version }}\"/" app/build.gradle.kts

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      #  BUILD APK
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ”¨ Build Debug APK
        id: build_apk
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”¨ Phase 2: Building APK"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          START_TIME=$(date +%s)
          
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee build-apk.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "build_duration=${DURATION}" >> $GITHUB_OUTPUT
          echo "build_exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
          
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
            echo "apk_size=${APK_SIZE}" >> $GITHUB_OUTPUT
            echo "âœ… APK built successfully (${APK_SIZE})"
          else
            echo "âŒ APK build failed"
            exit 1
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      #  RUNTIME SMOKE TEST
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ”¥ Runtime Smoke Test (Emulator API 24)
        if: steps.build_apk.outputs.build_exit_code == '0'
        uses: reactivecircus/android-emulator-runner@v2
        timeout-minutes: 12
        with:
          api-level: 24
          target: google_apis
          arch: x86_64
          profile: pixel_5
          script: |
            echo "ðŸ”¥ Starting Runtime Smoke Test..."
            
            adb install -r app/build/outputs/apk/debug/app-debug.apk
            echo "âœ… APK installed"
            
            adb shell am start -W com.excell44.educam.debug/com.excell44.educam.MainActivity
            echo "âœ… App launched"
            
            sleep 10
            
            adb logcat -d *:E | grep -E "FirebaseAuth|ClassNotFound|WorkManager|RuntimeException|FATAL" > runtime-errors.txt || true
            
            if [ -s runtime-errors.txt ]; then
              echo "âŒ RUNTIME ERRORS DETECTED:"
              cat runtime-errors.txt
              exit 1
            fi
            
            if ! adb shell pidof com.excell44.educam.debug > /dev/null; then
              echo "âŒ App crashed"
              exit 1
            fi
            
            echo "âœ… Runtime smoke test PASSED"

      - name: ðŸ“Š Phase 2 Metrics
        if: always()
        run: |
          cat > phase2-metrics.json << EOF
          {
            "phase": "2-build-smoke",
            "build_number": "${{ github.run_number }}",
            "build_duration_sec": "${{ steps.build_apk.outputs.build_duration }}",
            "apk_size": "${{ steps.build_apk.outputs.apk_size }}",
            "timestamp": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          }
          EOF
          cat phase2-metrics.json

      - name: ðŸ“¤ Upload APK for Phase 3
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ github.run_number }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 1

      - name: ðŸ“¤ Upload Phase 2 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase2-build-smoke-${{ github.run_number }}
          path: |
            build-apk.log
            phase2-metrics.json
            runtime-errors.txt
          retention-days: 30

    outputs:
      build_status: ${{ steps.build_apk.outputs.build_exit_code == '0' && 'success' || 'failure' }}
      apk_size: ${{ steps.build_apk.outputs.apk_size }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  PHASE 3 : PACKAGES & REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  package-and-report:
    name: ðŸ“¦ Phase 3 - Packages & Report
    runs-on: ubuntu-latest
    needs: [compile-and-test, build-and-smoke-test]
    if: always()

    steps:
      - name: ðŸ“¦ Download APK
        if: needs.build-and-smoke-test.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: debug-apk-${{ github.run_number }}
          path: apk/

      - name: ðŸ·ï¸ Package & Label APK
        if: needs.build-and-smoke-test.result == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“¦ Phase 3: Packaging APK"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          cd apk/
          APK_NAME="Bac-X_237-${{ needs.compile-and-test.outputs.version }}.apk"
          mv app-debug.apk "$APK_NAME"
          
          cat > BUILD-INFO.txt << EOF
          ðŸ“± Bac-X_237 Android Build
          ==========================================
          Version: ${{ needs.compile-and-test.outputs.version }}
          Version Code: ${{ needs.compile-and-test.outputs.version_code }}
          APK Size: ${{ needs.build-and-smoke-test.outputs.apk_size }}
          
          Phase 1 - Compilation: ${{ needs.compile-and-test.result }}
          Phase 2 - Build & Smoke: ${{ needs.build-and-smoke-test.result }}
          Phase 3 - Packaging: success
          
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Author: ${{ github.actor }}
          Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ==========================================
          EOF
          
          echo "âœ… APK packaged: ${APK_NAME}"
          cat BUILD-INFO.txt

      - name: ðŸ“¤ Upload Final Packaged APK
        if: needs.compile-and-test.result == 'success' && needs.build-and-smoke-test.result == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: Bac-X_237-APK-${{ needs.compile-and-test.outputs.version }}
          path: apk/*
          retention-days: 14

      - name: ðŸ“Š Generate Final Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "    ðŸŽ“ BAC-X_237 BUILD REPORT - Run #${{ github.run_number }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš™ï¸ PHASE 1 - Compiling & Unit Tests:    ${{ needs.compile-and-test.result }}"
          echo "   â””â”€ Duration: ${{ needs.compile-and-test.outputs.compile_duration }}s"
          echo ""
          echo "ðŸ”¨ PHASE 2 - Building APK & Smoke Test: ${{ needs.build-and-smoke-test.result }}"
          echo "   â””â”€ APK Size: ${{ needs.build-and-smoke-test.outputs.apk_size }}"
          echo ""
          echo "ðŸ“¦ PHASE 3 - Packages & Report:         success"
          echo ""
          echo "ðŸ“¦ Version: ${{ needs.compile-and-test.outputs.version }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          
          if [[ "${{ needs.compile-and-test.result }}" == "success" && "${{ needs.build-and-smoke-test.result }}" == "success" ]]; then
            echo "âœ… ALL PHASES SUCCESSFUL - APK READY FOR DEPLOYMENT"
          elif [[ "${{ needs.compile-and-test.result }}" == "failure" ]]; then
            echo "âŒ FAILED AT PHASE 1 - Check compilation-errors.md"
          elif [[ "${{ needs.build-and-smoke-test.result }}" == "failure" ]]; then
            echo "âŒ FAILED AT PHASE 2 - Check build-apk.log or runtime-errors.txt"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ’¬ PR Comment (Success)
        if: github.event_name == 'pull_request' && needs.compile-and-test.result == 'success' && needs.build-and-smoke-test.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.compile-and-test.outputs.version }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Build Successful - #${{ github.run_number }}
              
              **ðŸ“¦ APK:** \`Bac-X_237-${version}.apk\` (${{ needs.build-and-smoke-test.outputs.apk_size }})
              
              **Phase 1:** âš™ï¸ Compiling & Unit Tests - âœ… PASSED (${{ needs.compile-and-test.outputs.compile_duration }}s)
              **Phase 2:** ðŸ”¨ Building APK & Smoke Test - âœ… PASSED
              **Phase 3:** ðŸ“¦ Packages & Report - âœ… COMPLETED
              
              [ðŸ“¥ Download APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

      - name: ðŸ’¬ PR Comment (Failure)
        if: github.event_name == 'pull_request' && (needs.compile-and-test.result == 'failure' || needs.build-and-smoke-test.result == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            let failedPhase = '';
            let artifact = '';
            
            if ('${{ needs.compile-and-test.result }}' === 'failure') {
              failedPhase = 'Phase 1 (Compiling & Unit Tests)';
              artifact = 'compilation-errors.md';
            } else {
              failedPhase = 'Phase 2 (Building APK & Smoke Test)';
              artifact = 'build-apk.log or runtime-errors.txt';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Build Failed - #${{ github.run_number }}
              
              **Failed at:** ${failedPhase}
              
              **Phase 1:** Compiling & Unit Tests - ${{ needs.compile-and-test.result }}
              **Phase 2:** Building APK & Smoke Test - ${{ needs.build-and-smoke-test.result }}
              
              ðŸ“ **Error Report:** Check \`${artifact}\` in artifacts
              
              [ðŸ“ View All Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
