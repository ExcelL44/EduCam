name: ğŸ” Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

# Annuler les workflows prÃ©cÃ©dents si nouveau push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # âœ… CHECK 1 : Code Style & Format
  code-style:
    name: ğŸ“ Code Style
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pour diff avec base
          
      - name: ğŸ” Check Kotlin Code Style
        run: |
          echo "ğŸ” VÃ©rification du style de code..."
          
          # Chercher les TODOs non autorisÃ©s
          TODOS=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | \
            grep "\.kt$" | \
            xargs grep -n "TODO\|FIXME\|HACK" || true)
          
          if [ -n "$TODOS" ]; then
            echo "âš ï¸ AVERTISSEMENT : TODOs/FIXMEs trouvÃ©s :"
            echo "$TODOS"
            echo ""
            echo "ğŸ’¡ RÃ©soudre avant de merger ou ajouter un ticket"
          fi
          
      - name: ğŸ” Check File Size
        run: |
          echo "ğŸ” VÃ©rification de la taille des fichiers..."
          
          # Files > 500 lignes = suspect
          LARGE_FILES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | \
            grep "\.kt$" | \
            xargs wc -l | \
            awk '$1 > 500 {print $2 " (" $1 " lignes)"}' || true)
          
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ AVERTISSEMENT : Fichiers volumineux dÃ©tectÃ©s :"
            echo "$LARGE_FILES"
            echo ""
            echo "ğŸ’¡ ConsidÃ©rer la refactorisation"
          fi

  # âœ… CHECK 2 : Fail-Safe Compliance
  fail-safe-compliance:
    name: ğŸ›¡ï¸ Fail-Safe Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” Check Navigation Pattern
        run: |
          echo "ğŸ” VÃ©rification des patterns de navigation..."
          
          # Fichiers modifiÃ©s
          CHANGED_FILES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep "\.kt$" || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "â„¹ï¸ Aucun fichier Kotlin modifiÃ©"
            exit 0
          fi
          
          # Chercher navController.navigate() direct
          VIOLATIONS=""
          for file in $CHANGED_FILES; do
            if [[ "$file" != *"navigation/"* ]]; then
              FOUND=$(grep -n "navController\.navigate(" "$file" || true)
              if [ -n "$FOUND" ]; then
                VIOLATIONS="$VIOLATIONS\n$file:\n$FOUND"
              fi
            fi
          done
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ ERREUR : Navigation directe dÃ©tectÃ©e (INTERDIT)"
            echo -e "$VIOLATIONS"
            echo ""
            echo "âœ… Utiliser : navigationViewModel.navigate(NavCommand.NavigateTo(...))"
            exit 1
          else
            echo "âœ… Patterns de navigation corrects"
          fi
          
      - name: ğŸ” Check ViewModel Inheritance
        run: |
          echo "ğŸ” VÃ©rification de l'hÃ©ritage des ViewModels..."
          
          # ViewModels qui n'hÃ©ritent pas de BaseViewModel ou FailSafeViewModel
          CHANGED_VMS=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | \
            grep "ViewModel\.kt$" | \
            grep -v "BaseViewModel\|FailSafeViewModel\|NavigationViewModel" || true)
          
          if [ -z "$CHANGED_VMS" ]; then
            echo "â„¹ï¸ Aucun ViewModel modifiÃ©"
            exit 0
          fi
          
          for vm in $CHANGED_VMS; do
            if ! grep -q ": \(BaseViewModel\|FailSafeViewModel\)" "$vm"; then
              echo "âš ï¸ AVERTISSEMENT : $vm n'hÃ©rite pas de BaseViewModel/FailSafeViewModel"
              echo "ğŸ’¡ Recommandation : HÃ©riter de FailSafeViewModel pour la protection automatique"
            fi
          done
          
      - name: ğŸ” Check Repository Pattern
        run: |
          echo "ğŸ” VÃ©rification des repositories..."
          
          # Repositories modifiÃ©s
          CHANGED_REPOS=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | \
            grep "Repository\.kt$" || true)
          
          if [ -z "$CHANGED_REPOS" ]; then
            echo "â„¹ï¸ Aucun repository modifiÃ©"
            exit 0
          fi
          
          for repo in $CHANGED_REPOS; do
            # Chercher suspend fun qui ne retournent pas Result<T>
            UNSAFE=$(grep -n "suspend fun.*): [^R]" "$repo" || true)
            if [ -n "$UNSAFE" ]; then
              echo "âš ï¸ AVERTISSEMENT : $repo contient des suspend fun sans Result<T>"
              echo "$UNSAFE"
              echo ""
              echo "ğŸ’¡ Utiliser FailSafeRepositoryHelper.executeSafely()"
            fi
          done

  # âœ… CHECK 3 : Test Coverage
  test-coverage:
    name: ğŸ“Š Test Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew
        
      - name: ğŸ§ª Run Tests with Coverage
        run: ./gradlew testDebugUnitTest jacocoTestReport --stacktrace
        continue-on-error: true
        
      - name: ğŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./app/build/reports/jacoco/test/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # âœ… CHECK 4 : Security Scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“Š Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # âœ… CHECK 5 : Build APK
  build-apk:
    name: ğŸ”¨ Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew
        
      - name: ğŸ”¨ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
        
      - name: ğŸ“¦ Upload APK for Testing
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  # âœ… COMMENTAIRE AUTOMATIQUE SUR LA PR
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [code-style, fail-safe-compliance, test-coverage, security-scan, build-apk]
    if: always()
    
    steps:
      - name: ğŸ’¬ Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Code Style': '${{ needs.code-style.result }}',
              'Fail-Safe Compliance': '${{ needs.fail-safe-compliance.result }}',
              'Test Coverage': '${{ needs.test-coverage.result }}',
              'Security Scan': '${{ needs.security-scan.result }}',
              'Build APK': '${{ needs.build-apk.result }}'
            };
            
            let status = 'âœ…';
            let message = '## ğŸ‰ Tous les checks sont passÃ©s!\n\n';
            
            for (const [check, result] of Object.entries(results)) {
              const icon = result === 'success' ? 'âœ…' : 'âŒ';
              message += `${icon} **${check}**: ${result}\n`;
              if (result !== 'success') status = 'âŒ';
            }
            
            message += '\n---\n';
            
            if (status === 'âœ…') {
              message += 'ğŸ›¡ï¸ **Cette PR respecte tous les standards Fail-Safe**\n';
              message += 'ğŸš€ PrÃªt pour review et merge\n';
            } else {
              message += 'âš ï¸ **Certains checks ont Ã©chouÃ©**\n';
              message += 'ğŸ”§ Corriger les problÃ¨mes avant de merger\n';
            }
            
            message += '\nğŸ“Š [Voir les dÃ©tails complets](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
